<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create New User</title>
</head>
<body>
    <h1>Create New User</h1>
    <button id="createUserBtn" style="font-size:2em;padding:1em 2em;">Create New User</button>
    <form id="createUserForm" style="display:none; margin-top:2em;">
        <input type="hidden" id="user_id" name="user_id">
        <input type="hidden" id="device_fingerprint" name="device_fingerprint">
    </form>
    <div id="result" style="margin-top:2em;"></div>
    <script>
        // Generate UUID (u--uuid)
        function generateUserId() {
            if (window.crypto && window.crypto.randomUUID) {
                return 'u--' + window.crypto.randomUUID();
            }
            // Fallback for older browsers
            function uuidv4() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            return 'u--' + uuidv4();
        }

        // Simple browser fingerprint (userAgent + screen + platform)
        function getBrowserFingerprint() {
            const data = [
                navigator.userAgent,
                navigator.language,
                navigator.platform,
                screen.width,
                screen.height,
                screen.colorDepth
            ].join('::');
            // Simple hash (FNV-1a)
            let hash = 2166136261;
            for (let i = 0; i < data.length; i++) {
                hash ^= data.charCodeAt(i);
                hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
            }
            return Math.abs(hash).toString(16);
        }

        // On page load, try to get device fingerprint from backend, else use browser fingerprint
        const userId = generateUserId();
        let deviceFingerprint = getBrowserFingerprint();
        fetch('/deviceid')
            .then(res => res.json())
            .then(data => {
                if (data.device_fingerprints && data.device_fingerprints.length > 0) {
                    deviceFingerprint = data.device_fingerprints[0];
                }
                document.getElementById('user_id').value = userId;
                document.getElementById('device_fingerprint').value = deviceFingerprint;
            })
            .catch(() => {
                document.getElementById('user_id').value = userId;
                document.getElementById('device_fingerprint').value = deviceFingerprint;
            });

        // Helper: decode base64url to Uint8Array
        function decodeBase64Url(str) {
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            while (str.length % 4) str += '=';
            return Uint8Array.from(atob(str), c => c.charCodeAt(0));
        }

        document.getElementById('createUserBtn').addEventListener('click', async function() {
            document.getElementById('createUserBtn').disabled = true;
            document.getElementById('result').textContent = 'Creating user...';
            const payload = {
                user_id: userId,
                device_fingerprints: [document.getElementById('device_fingerprint').value]
            };
            try {
                console.log('Step 1: Creating user', payload);
                // 1. Create user
                const res = await fetch('/users/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('Failed to create user');
                const user = await res.json();
                console.log('Step 1 result:', user);

                // 2. Get WebAuthn registration options
                document.getElementById('result').textContent = 'Getting passkey registration options...';
                console.log('Step 2: Fetching WebAuthn registration options');
                const optionsRes = await fetch('/webauthn/register/options', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: user.user_id })
                });
                if (!optionsRes.ok) throw new Error('Failed to get registration options');
                const options = await optionsRes.json();
                console.log('Step 2 result:', options);

                // 3. Prepare options for WebAuthn API
                options.challenge = decodeBase64Url(options.challenge);
                options.user.id = decodeBase64Url(options.user.id);
                if (options.excludeCredentials) {
                    options.excludeCredentials = options.excludeCredentials.map(cred => {
                        if (cred.id) cred.id = decodeBase64Url(cred.id);
                        return cred;
                    });
                }
                console.log('Step 3: Prepared options for WebAuthn', options);

                // 4. Call WebAuthn API
                document.getElementById('result').textContent = 'Initiating passkey setup...';
                let credential;
                if (!navigator.credentials || typeof navigator.credentials.create !== 'function') {
                    throw new Error('WebAuthn is not supported in this browser or context. Make sure you are using a supported browser and accessing this page via HTTPS or localhost.');
                }
                try {
                    console.log('Step 4: Calling navigator.credentials.create');
                    credential = await navigator.credentials.create({ publicKey: options });
                    console.log('Step 4 result:', credential);
                } catch (e) {
                    console.error('WebAuthn failed:', e);
                    throw new Error('WebAuthn failed: ' + e.message);
                }

                // 5. Send attestation to backend
                document.getElementById('result').textContent = 'Verifying passkey...';
                const attestation = {
                    id: credential.id,
                    rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
                    type: credential.type,
                    response: {
                        clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON))),
                        attestationObject: btoa(String.fromCharCode(...new Uint8Array(credential.response.attestationObject)))
                    }
                };
                console.log('Step 5: Sending attestation', attestation);
                const verifyRes = await fetch('/webauthn/register/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: user.user_id, attestation })
                });
                if (!verifyRes.ok) throw new Error('Failed to verify passkey');
                const verifyData = await verifyRes.json();
                console.log('Step 5 result:', verifyData);

                // 6. Show result
                document.getElementById('result').textContent =
                    'User created and passkey registered!';

            } catch (err) {
                console.error('Error in registration flow:', err);
                document.getElementById('result').textContent = 'Error: ' + err;
            }
            document.getElementById('createUserBtn').disabled = false;
        });

    </script>
</body>
</html>